#!/bin/bash

# Install latest node version

source bash-helpers

node_dst=~/opt/node

if [[ -e $node_dst || -h $node_dst ]] ; then

    if [[ $1 != "--force" ]] ; then
        DIE "Directory $node_dst already exists - use --force if you are sure"
    fi

    rm $node_dst
fi


wd=$(mktemp -d)
cd $wd

bits=$(uname -m | perl -ne 'print $1 if /_(32|64)$/')

url=https://nodejs.org/dist/latest

file=$(wget -q -O - $url | perl -ne 'print $1 if /(node-v[\d\.]+-linux-x'$bits'.tar.gz)/i')
url=$url/$file
dir=$(echo $file | perl -pe 's/\.tar.gz//g')

INFO "Downloading: $url to $file"
wget -q $url

INFO "Extracting to $dir"
tar xfz $file

rm $file

mkdir -p ~/opt/bin

node_dst_versioned=~/opt/$dir

if [[ -e $node_dst_versioned ]] ; then
    node_bak=${node_dst_versioned}_$(date +%Y%m%d_%H%M%S)
    WARN "Backing up existing node to $node_bak"
    mv $node_dst_versioned $node_bak
fi

mv $dir $node_dst_versioned

cd ~/opt
ln -s $dir node

cd ~/opt/bin

rm -f ~/opt/bin/node
rm -f ~/opt/bin/npm
ln -s ../node/bin/node .
ln -s ../node/bin/npm .

npm-set-global-modules-dir

INFO "Done."
